# rough_to_illustration

生成AIでラフ絵からイラストを作成するFlaskアプリケーション。ログイン後にモードを切り替え、(1) ラフ1枚＋テキスト指示、または (2) 完成絵参照＋ラフ（2枚）を送信して、Gemini API で生成したイラストをプレビュー・ダウンロードできます。アップロード時のプレビュー、文字数カウンタ、送信中のローディング表示などリッチなUIを備えています。

### 自分宛てのメモ
- ~~プリセットの設定が200文字と300文字になっているので文字数の設定を緩和すること。modelsと、フロントエンドの設定を修正することで対応。~~
- ~~フロントエンドに説明が追加されているが、不要な説明や間違っている説明が多いので(生成AIで作成したので)削除すること~~
- モード切替の実装(イメージ→イメージモードや、ほかのイラストを画風を元に生成するモード)
- requirementsが若干怪しい気がするので確認

## 主な機能
- Flask + SQLAlchemy + Flask-Login によるログイン必須のWeb UI
- モード切替（ラフ＋指示 / 完成絵参照＋ラフ）
- ラフ絵アップロードと色指定・ポーズ指示（任意のアスペクト比/解像度入力）
- 完成済みイラストを参照してラフを仕上げる 2枚画像モード（任意のアスペクト比/解像度入力）
- アップロードプレビュー、文字数カウンタ、送信中のローディング表示を備えたリッチUI
- Gemini API を呼び出して生成した画像のプレビューとダウンロード

## ディレクトリ構成
- `app.py`: Flaskアプリのエントリポイント。Blueprint登録のみを担当。
- `config.py` / `extensions.py` / `models.py`: 設定値、拡張機能のインスタンス、ユーザーモデル。
- `services/`: プロンプト生成や画像生成処理のヘルパー。
- `views/`: 認証とメイン画面のBlueprint。
- `templates/`: リッチなUIを定義したJinja2テンプレート。
- `old/streamlit/`: 旧Streamlitモックアップのコードを保管（現行アプリでは未使用）。

## 事前準備
1. 依存関係のインストール
   ```bash
   pip install -r requirements.txt
   ```
2. `.env` に API キーなどを設定
   ```bash
   GEMINI_API_KEY="<GeminiのAPIキー>"     # 互換のため GOOGLE_API_KEY でも可
   SECRET_KEY="任意の秘密鍵"             # 省略時はデフォルト値を使用
   DATABASE_URL="sqlite:///app.db"      # 任意、未指定ならSQLiteファイルを利用
   ```
3. データベース初期化と初回ユーザー作成 (例)
   ```bash
   flask --app app.py shell
   >>> from app import db, User
   >>> db.create_all()
   >>> u = User(username="demo", email="demo@example.com")
   >>> u.set_password("password123")
   >>> db.session.add(u); db.session.commit(); exit()
   ```

## 起動方法
```bash
flask --app app.py run  # または python app.py
```
ブラウザで `http://localhost:5000/` にアクセスし、登録済みユーザーでログインしてください。ログインしないと生成フォームは利用できません。

### UIのヒント
- 画面上部の「モード」で生成方法を切り替えられます。
- ラフ絵をアップロードするとプレビューが表示されます。不要になった場合は「画像をクリア」でリセットできます。
- テキスト入力には文字数カウンタがあり、推奨の文字数ガイドを併記しています。
- 送信中はボタンが自動で無効化され、スピナーが表示されます。

## 使い方
1. ログイン後、画面上部の「モード」を選択します。
2. モードに応じて画像を選択し、必要に応じてアスペクト比・解像度を指定します。
   - ラフ→仕上げ（色・ポーズ指示）: ラフスケッチ1枚＋色/ポーズ指示
   - 完成絵参照→ラフ着色（2枚）: 参考（完成）画像1枚＋ラフスケッチ1枚（プロンプトは暫定的に固定）
3. 「イラスト生成（または参照して着色）」を押すと Gemini API に送信され、生成画像がプレビューされます。
4. 「生成画像をダウンロード」ボタンからPNG形式で保存できます。

## 備考
- 画像やデータベースファイルは `.gitignore` に含めています。
- Gemini API の利用方法は [公式ドキュメント](https://ai.google.dev/gemini-api/docs/image-understanding?hl=ja) を参照してください。


## 編集モード（インペイント/アウトペイント）
- 「編集」モードを選択し、編集対象画像をアップロードするとエディタが開きます。
- エディタで赤く塗った領域が編集対象です。インペイント/アウトペイントはボタンで切り替えます。
- 透明アルファ付きPNGをアップロードした場合、透明部分がマスクとして扱われます。
- 追加指示がない場合は、元の構図・色味・絵柄を維持したままマスク領域のみ編集します。
