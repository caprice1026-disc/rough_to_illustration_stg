# 色・ポーズプリセット保存とUI分割対応計画

このExecPlanはPLANS.mdの要件に従い、作業の進行に合わせて更新し続ける。進行状況、発見事項、決定事項、振り返りを常に最新に保ち、単独で読んでも初心者が同じ変更を完遂できる内容とする。

## Purpose / Big Picture

ログインユーザーがよく使う色指定やポーズ指示をプリセットとして保存し、再利用や削除ができるようにする。さらに現状テンプレートに埋め込まれているスタイルとスクリプトを外部ファイルへ分割し、保守性を高める。結果としてユーザーは自分専用のプリセットを簡単に呼び出して送信内容を素早く準備でき、開発者はUIのスタイルや動作を個別に編集しやすくなる。

## Progress

- [x] (2024-06-09 00:00Z) 既存構成の調査と要件整理を完了。
- [x] (2024-06-09 00:25Z) プリセット用データモデルを追加し、DB自動作成によりカバー可能であることを確認。
- [x] (2024-06-09 00:50Z) プリセットの登録・読込・削除ビューを追加し、入力バリデーションとユーザー限定の取得に対応。
- [x] (2024-06-09 01:05Z) テンプレートのHTMLからスタイルとJSを切り出し、静的ファイルとして読み込む形へ変更。
- [x] (2024-06-09 01:10Z) UIにプリセット管理の表示・保存・読込・削除の動線を追加し、テキストエリアと連動させた。
- [x] (2024-06-09 01:22Z) コンパイルチェックで構文エラーがないことを確認し、計画の振り返りを更新。

## Surprises & Discoveries

- まだなし。進めながら発見があれば証拠とともに記録する。

## Decision Log

- 決定: プリセット作成時は色・ポーズの入力欄（メインテキストエリア）の内容をそのまま保存する仕様とし、専用の入力欄は設けない。
  Rationale: 入力箇所を増やさずに一貫したデータを保持でき、既存フォームとの整合性を保てるため。
  Date/Author: 2024-06-09 / assistant
- 決定: 画面表示用のプリセットデータは `data-presets` 属性にJSONとして埋め込み、クライアント側で読込・適用する。
  Rationale: 追加APIを増やさずページロード時に必要十分な情報を提供できるため、構造が簡潔になる。
  Date/Author: 2024-06-09 / assistant

## Outcomes & Retrospective

- ユーザーごとに色・ポーズのプリセットを保存・適用・削除できるようになり、フォームの色/ポーズ入力と連動するUIを用意した。
- ベースレイアウトとトップページのスタイル/スクリプトを静的ファイルへ分割し、保守しやすい構成へ整理した。
- `python -m compileall .` を実行して構文エラーがないことを確認済み。今後は実際のブラウザ操作でプリセット登録〜削除の一連の流れを確認する。

## Context and Orientation

- Flaskアプリのエントリーポイントは `app.py`。Blueprintは `views/main.py` と `views/auth.py` に分割されている。
- ユーザーモデルは `models.py` で定義され、SQLiteをデフォルトにSQLAlchemyを利用。
- 生成処理は `services/generation_service.py` と `services/prompt_builder.py` で、画面は `templates/index.html` を中心に `templates/base.html` にスタイル・スクリプトが内包されている。
- 静的ファイルディレクトリは未整備のため、新規に `static/css` と `static/js` を作成して読み込む必要がある。

## Plan of Work

まずユーザーと紐づくプリセットテーブルを追加し、色指示とポーズ指示を文字列で保持する。プリセット名を付けて複数保存できるようにし、所有者以外からは見えないようクエリを限定する。`views/main.py` にプリセット取得・作成・削除の処理を追加し、フォーム送信や削除リンクで操作できるようにする。フロントエンドではプリセット一覧を表示し、選択するとテキストエリアへ内容をセット、登録と削除の動線を用意する。UIのJSとCSSは `templates/base.html` と `templates/index.html` から外部ファイルへ移動し、Jinjaの変数が必要な箇所はデータ属性やサーバーからの初期データで対応する。

## Concrete Steps

1. `models.py` にプリセットモデルを追加し、ユーザー外部キーと色・ポーズ・名称のカラムを定義する。`db.create_all()` により自動作成されるため追加後にサーバー起動またはテスト時にDBを初期化する。
2. `views/main.py` でプリセットCRUDのルートやヘルパーを追加し、現在のユーザー専用にスコープする。POSTで登録、GETで読み込み、POST/DELETE相当で削除を処理し、フラッシュメッセージを返す。
3. `templates/index.html` へプリセット一覧UI（選択・登録・削除）を組み込み、サーバーから提供するプリセットを描画する。JinjaはHTMLのみ保持し、スタイル・JSは外部ファイルへ委譲する。
4. `templates/base.html` と `templates/index.html` に埋め込まれたCSS/JSを `static/css/base.css` `static/css/index.css` `static/js/base.js` `static/js/index.js` へ移動し、`url_for('static', ...)` で読み込むように修正する。必要に応じてデータ属性を付与してJSからDOMを取得しやすくする。
5. 動作確認としてアプリを起動し、プリセット登録→選択→削除のフローと既存の画像生成フォーム送信が問題なく行えることを目視確認する。テキストエリアカウンタやドラッグ＆ドロッププレビューが継続して動くことも確認する。

## Validation and Acceptance

- サーバーを起動し、ログイン後に色・ポーズプリセットを新規登録できる。登録直後に一覧へ追加され、選択するとテキストエリアが埋まること。
- 一覧の削除操作で対象プリセットが消え、他ユーザーのプリセットは表示されないこと。
- CSSとJSが外部ファイルに分割されていて、ブラウザ上で同等のスタイルと挙動（カウンタ更新、ドラッグ＆ドロップ、送信中ボタン無効化、フラッシュ自動クローズ）が維持されていること。

## Idempotence and Recovery

- `db.create_all()` を再実行しても既存テーブルを壊さず新規テーブルが作成されるため安全。フォーム操作に失敗した場合はフラッシュで理由が表示され、再送信すればよい。
- 静的ファイル分割はテンプレート側の読み込みパスに依存するため、キャッシュが残る場合はブラウザリロード（キャッシュクリア）で解消できる。

## Artifacts and Notes

- 実行コマンド例や確認ログは作業中に必要になればここへ追記する。

## Interfaces and Dependencies

- 新規モデル `IllustrationPreset`（仮称）を `models.py` に追加し、`id`, `user_id`, `name`, `color_instruction`, `pose_instruction`, `created_at` を持つ。`user_id` は `User.id` への外部キーで、`User` とのリレーションを通じて所有者を取得する。
- ビュー関数は `views/main.py` に追加し、`@login_required` を付与して `current_user` からプリセットを取得する。登録はPOST `/presets`、削除はPOST `/presets/<id>/delete`、一覧読み込みは`index`レンダリング時に `user_presets` として渡す。
- フロントエンドの主要挙動は `static/js/index.js` で提供し、JinjaからプリセットJSONをデータ属性（例: `<div id="presetContainer" data-presets="[...]">`）として埋め込んで読み込む。
